{"ast":null,"code":"import _JSON$stringify from \"@babel/runtime-corejs2/core-js/json/stringify\";\nimport _Array$isArray from \"@babel/runtime-corejs2/core-js/array/is-array\";\nimport _regeneratorRuntime from \"@babel/runtime-corejs2/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime-corejs2/helpers/esm/asyncToGenerator\";\nimport _Promise from \"@babel/runtime-corejs2/core-js/promise\";\nvar __jsx = React.createElement;\nimport React, { useEffect, useState } from 'react';\nimport Head from 'next/head';\nimport { useRouter } from 'next/router';\nimport { useDispatch, useSelector } from 'react-redux';\nimport Frame from 'react-frame-component';\nimport { withRedux } from '../lib/redux';\nimport Layout from '../components/layout';\nimport Meta from '../components/meta';\nimport Nav from '../components/nav';\nimport Sidebar from '../components/sidebar';\nimport LoggedIn from '../components/loggedIn';\nimport Onboarding from '../components/onboarding';\nimport Loading from '../components/loading';\nimport { saveAuthData, saveUserId } from '../actions/auth';\nimport { saveProfileData } from '../actions/profile';\nimport { blockstackAPI, IdentifierAPI, themeAPI } from '../api';\nimport anchorme from 'anchorme';\nimport handlebars from 'handlebars';\n\nvar readFileAsBuffer = function readFileAsBuffer(file) {\n  var temporaryFileReader = new FileReader();\n  return new _Promise(function (resolve, reject) {\n    temporaryFileReader.onload = function () {\n      resolve(temporaryFileReader.result);\n    };\n\n    temporaryFileReader.readAsArrayBuffer(file);\n  });\n};\n\nvar Dashboard = function Dashboard() {\n  var dispatch = useDispatch();\n  var router = useRouter();\n\n  var _useState = useState(''),\n      name = _useState[0],\n      setName = _useState[1];\n\n  var _useState2 = useState(''),\n      description = _useState2[0],\n      setDescription = _useState2[1];\n\n  var _useState3 = useState(''),\n      avatarUrl = _useState3[0],\n      setAvatarUrl = _useState3[1];\n\n  var _useState4 = useState(''),\n      avatarFile = _useState4[0],\n      setAvatarFile = _useState4[1];\n\n  var _useState5 = useState([]),\n      accountList = _useState5[0],\n      setAccountList = _useState5[1];\n\n  var _useState6 = useState([]),\n      themeList = _useState6[0],\n      setThemeList = _useState6[1];\n\n  var _useState7 = useState(''),\n      theme = _useState7[0],\n      setTheme = _useState7[1];\n\n  var _useState8 = useState(''),\n      identifier = _useState8[0],\n      setIdentifier = _useState8[1];\n\n  var _useState9 = useState(''),\n      template = _useState9[0],\n      setTemplate = _useState9[1];\n\n  var _useState10 = useState(''),\n      submitState = _useState10[0],\n      setSubmitState = _useState10[1];\n\n  var _useState11 = useState(true),\n      loadingState = _useState11[0],\n      setLoadingState = _useState11[1];\n\n  var authData = useSelector(function (state) {\n    return state.auth.authData;\n  });\n  var profile = useSelector(function (state) {\n    return state.profile;\n  });\n\n  var _useState12 = useState(false),\n      showProfileSidebar = _useState12[0],\n      setShowProfileSidebar = _useState12[1];\n\n  var _useState13 = useState(true),\n      showOnboarding = _useState13[0],\n      setShowOnboarding = _useState13[1];\n\n  var logout =\n  /*#__PURE__*/\n  function () {\n    var _ref = _asyncToGenerator(\n    /*#__PURE__*/\n    _regeneratorRuntime.mark(function _callee() {\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              _context.next = 2;\n              return blockstackAPI.session.signUserOut();\n\n            case 2:\n              dispatch(saveAuthData(null));\n\n            case 3:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    }));\n\n    return function logout() {\n      return _ref.apply(this, arguments);\n    };\n  }();\n\n  var submit =\n  /*#__PURE__*/\n  function () {\n    var _ref2 = _asyncToGenerator(\n    /*#__PURE__*/\n    _regeneratorRuntime.mark(function _callee2(e, onboarding) {\n      var newProfile, buff, newAvatarUrl, newData, newId, _newId;\n\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              e.preventDefault();\n              setSubmitState('pending');\n              _context2.prev = 2;\n              newProfile = {\n                name: name,\n                description: description,\n                avatarUrl: avatarUrl,\n                accountList: accountList,\n                theme: theme\n              };\n\n              if (!avatarFile) {\n                _context2.next = 12;\n                break;\n              }\n\n              _context2.next = 7;\n              return readFileAsBuffer(avatarFile);\n\n            case 7:\n              buff = _context2.sent;\n              _context2.next = 10;\n              return blockstackAPI.session.putFile('avatar.png', buff, {\n                encrypt: false\n              });\n\n            case 10:\n              newAvatarUrl = _context2.sent;\n              newProfile.avatarUrl = newAvatarUrl;\n\n            case 12:\n              if (!onboarding) {\n                _context2.next = 20;\n                break;\n              }\n\n              newData = {\n                identifier: identifier,\n                blockstackId: authData.username,\n                profile: newProfile\n              };\n              newId = new IdentifierAPI(newData);\n              _context2.next = 17;\n              return newId.save();\n\n            case 17:\n              dispatch(saveUserId(identifier));\n              _context2.next = 26;\n              break;\n\n            case 20:\n              _context2.next = 22;\n              return IdentifierAPI.findOne({\n                identifier: identifier\n              });\n\n            case 22:\n              _newId = _context2.sent;\n\n              _newId.update({\n                profile: newProfile\n              });\n\n              _context2.next = 26;\n              return _newId.save();\n\n            case 26:\n              dispatch(saveProfileData(newProfile));\n              setSubmitState('fulfilled');\n              _context2.next = 33;\n              break;\n\n            case 30:\n              _context2.prev = 30;\n              _context2.t0 = _context2[\"catch\"](2);\n              setSubmitState('rejected');\n\n            case 33:\n              setTimeout(function () {\n                setSubmitState('');\n              }, 1000);\n\n            case 34:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2, null, [[2, 30]]);\n    }));\n\n    return function submit(_x, _x2) {\n      return _ref2.apply(this, arguments);\n    };\n  }();\n\n  useEffect(function () {\n    var checkAuthData =\n    /*#__PURE__*/\n    function () {\n      var _ref3 = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee3() {\n        var getAuthData, id;\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                if (!blockstackAPI.session.isUserSignedIn()) {\n                  _context3.next = 13;\n                  break;\n                }\n\n                if (authData) {\n                  _context3.next = 6;\n                  break;\n                }\n\n                _context3.next = 4;\n                return blockstackAPI.session.loadUserData();\n\n              case 4:\n                getAuthData = _context3.sent;\n                dispatch(saveAuthData(getAuthData));\n\n              case 6:\n                _context3.next = 8;\n                return IdentifierAPI.findOne({\n                  identifier: identifier\n                });\n\n              case 8:\n                id = _context3.sent;\n\n                if (id) {\n                  setShowOnboarding(false);\n                  dispatch(saveProfileData(id.attrs.profile));\n                  dispatch(saveUserId(id.attrs.identifier));\n                }\n\n                setTimeout(function () {\n                  setLoadingState(false);\n                }, 500);\n                _context3.next = 14;\n                break;\n\n              case 13:\n                router.replace('/login');\n\n              case 14:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3);\n      }));\n\n      return function checkAuthData() {\n        return _ref3.apply(this, arguments);\n      };\n    }();\n\n    checkAuthData();\n\n    var fetchThemeList =\n    /*#__PURE__*/\n    function () {\n      var _ref4 = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee4() {\n        var response;\n        return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                _context4.next = 2;\n                return themeAPI.fetch();\n\n              case 2:\n                response = _context4.sent;\n                setThemeList(response.data.data);\n\n              case 4:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4);\n      }));\n\n      return function fetchThemeList() {\n        return _ref4.apply(this, arguments);\n      };\n    }();\n\n    fetchThemeList();\n  }, []);\n  useEffect(function () {\n    if (profile.name) {\n      setName(profile.name);\n    }\n\n    if (profile.description) {\n      setDescription(profile.description);\n    }\n\n    if (_Array$isArray(profile.accountList)) {\n      var cloneAccountList = JSON.parse(_JSON$stringify(profile.accountList));\n      setAccountList(cloneAccountList);\n    }\n\n    if (profile.avatarUrl) {\n      setAvatarUrl(profile.avatarUrl);\n    }\n\n    if (profile.theme) {\n      var cloneTheme = JSON.parse(_JSON$stringify(profile.theme));\n      setTheme(cloneTheme);\n    }\n  }, [profile]);\n  useEffect(function () {\n    var currentData = JSON.parse(_JSON$stringify({\n      name: name,\n      description: description,\n      avatarUrl: avatarUrl,\n      accountList: accountList\n    }));\n\n    if (currentData.description) {\n      currentData.description = anchorme(currentData.description, {\n        attributes: [{\n          name: \"target\",\n          value: \"_blank\"\n        }]\n      });\n    }\n\n    if (theme) {\n      var path = 'index';\n      var page = theme.templatePage.find(function (page) {\n        return page.path === path;\n      });\n      var compiled = handlebars.compile(page.template || '')(currentData);\n      setTemplate(compiled);\n    }\n  }, [theme, name, description, avatarUrl, accountList]);\n\n  var toggleProfileSidebar = function toggleProfileSidebar() {\n    setShowProfileSidebar(!showProfileSidebar);\n  };\n\n  return __jsx(Layout, null, __jsx(Head, null, __jsx(\"title\", null, \"Dashboard | Paras\"), __jsx(\"link\", {\n    rel: \"icon\",\n    href: \"/favicon.ico\"\n  })), __jsx(Meta, null), __jsx(LoggedIn, null), loadingState && __jsx(Loading, null), __jsx(Nav, {\n    toggleProfileSidebar: toggleProfileSidebar\n  }), showOnboarding && __jsx(Onboarding, {\n    identifier: identifier,\n    setIdentifer: setIdentifier,\n    name: name,\n    setName: setName,\n    description: description,\n    setDescription: setDescription,\n    accountList: accountList,\n    setAccountList: setAccountList,\n    avatarUrl: avatarUrl,\n    setAvatarUrl: setAvatarUrl,\n    avatarFile: avatarFile,\n    setAvatarFile: setAvatarFile,\n    theme: theme,\n    setTheme: setTheme,\n    themeList: themeList,\n    submit: submit,\n    submitState: submitState,\n    showOnboarding: showOnboarding,\n    setShowOnboarding: setShowOnboarding\n  }), __jsx(Sidebar, {\n    name: name,\n    setName: setName,\n    description: description,\n    setDescription: setDescription,\n    accountList: accountList,\n    setAccountList: setAccountList,\n    avatarUrl: avatarUrl,\n    setAvatarUrl: setAvatarUrl,\n    avatarFile: avatarFile,\n    setAvatarFile: setAvatarFile,\n    theme: theme,\n    setTheme: setTheme,\n    themeList: themeList,\n    submit: submit,\n    submitState: submitState,\n    showProfileSidebar: showProfileSidebar,\n    toggleProfileSidebar: toggleProfileSidebar,\n    logout: logout\n  }), __jsx(Frame, {\n    className: \"w-screen\",\n    style: {\n      height: \"calc(100vh - 2.5rem)\"\n    }\n  }, __jsx(\"div\", {\n    dangerouslySetInnerHTML: {\n      __html: template\n    }\n  })));\n};\n\nexport default withRedux(Dashboard);","map":{"version":3,"sources":["/Users/riqi/Projects/persona-app/dashboard/pages/dash.js"],"names":["React","useEffect","useState","Head","useRouter","useDispatch","useSelector","Frame","withRedux","Layout","Meta","Nav","Sidebar","LoggedIn","Onboarding","Loading","saveAuthData","saveUserId","saveProfileData","blockstackAPI","IdentifierAPI","themeAPI","anchorme","handlebars","readFileAsBuffer","file","temporaryFileReader","FileReader","resolve","reject","onload","result","readAsArrayBuffer","Dashboard","dispatch","router","name","setName","description","setDescription","avatarUrl","setAvatarUrl","avatarFile","setAvatarFile","accountList","setAccountList","themeList","setThemeList","theme","setTheme","identifier","setIdentifier","template","setTemplate","submitState","setSubmitState","loadingState","setLoadingState","authData","state","auth","profile","showProfileSidebar","setShowProfileSidebar","showOnboarding","setShowOnboarding","logout","session","signUserOut","submit","e","onboarding","preventDefault","newProfile","buff","putFile","encrypt","newAvatarUrl","newData","blockstackId","username","newId","save","findOne","update","setTimeout","checkAuthData","isUserSignedIn","loadUserData","getAuthData","id","attrs","replace","fetchThemeList","fetch","response","data","cloneAccountList","JSON","parse","cloneTheme","currentData","attributes","value","path","page","templatePage","find","compiled","compile","toggleProfileSidebar","height","__html"],"mappings":"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","sourcesContent":["import React, { useEffect, useState } from 'react'\nimport Head from 'next/head'\nimport { useRouter } from 'next/router'\nimport { useDispatch, useSelector } from 'react-redux'\nimport Frame from 'react-frame-component'\n\nimport { withRedux } from '../lib/redux'\nimport Layout from '../components/layout'\nimport Meta from '../components/meta'\nimport Nav from '../components/nav'\nimport Sidebar from '../components/sidebar'\nimport LoggedIn from '../components/loggedIn'\nimport Onboarding from '../components/onboarding'\nimport Loading from '../components/loading'\n\nimport { saveAuthData, saveUserId } from '../actions/auth'\nimport { saveProfileData } from '../actions/profile'\nimport { blockstackAPI, IdentifierAPI, themeAPI } from '../api'\nimport anchorme from 'anchorme'\nimport handlebars from 'handlebars'\n\nconst readFileAsBuffer = (file) => {\n  const temporaryFileReader = new FileReader()\n\n  return new Promise((resolve, reject) => {\n    temporaryFileReader.onload = () => {\n      resolve(temporaryFileReader.result)\n    }\n    temporaryFileReader.readAsArrayBuffer(file)\n  })\n}\n\nconst Dashboard = () => {\n  const dispatch = useDispatch()\n  const router = useRouter()\n  const [name, setName] = useState('')\n  const [description, setDescription] = useState('')\n  const [avatarUrl, setAvatarUrl] = useState('')\n  const [avatarFile, setAvatarFile] = useState('')\n  const [accountList, setAccountList] = useState([])\n  const [themeList, setThemeList] = useState([])\n  const [theme, setTheme] = useState('')\n  const [identifier, setIdentifier] = useState('')\n  const [template, setTemplate] = useState('')\n  const [submitState, setSubmitState] = useState('')\n  const [loadingState, setLoadingState] = useState(true)\n\n  const authData = useSelector(state => state.auth.authData)\n  const profile = useSelector(state => state.profile)\n\n  const [showProfileSidebar, setShowProfileSidebar] = useState(false)\n  const [showOnboarding, setShowOnboarding] = useState(true)\n\n  const logout = async () => {\n    await blockstackAPI.session.signUserOut()\n    dispatch(saveAuthData(null))\n  }\n\n  const submit = async (e, onboarding) => {\n    e.preventDefault()\n\n    setSubmitState('pending')\n\n    try {\n      const newProfile = {\n        name: name,\n        description: description,\n        avatarUrl: avatarUrl,\n        accountList: accountList,\n        theme: theme\n      }\n      if(avatarFile) {\n        const buff = await readFileAsBuffer(avatarFile)\n        const newAvatarUrl = await blockstackAPI.session.putFile('avatar.png', buff, {\n          encrypt: false\n        })\n        newProfile.avatarUrl = newAvatarUrl\n      }\n\n      if(onboarding) {\n        const newData = {\n          identifier: identifier,\n          blockstackId: authData.username,\n          profile: newProfile\n        }\n        const newId = new IdentifierAPI(newData)\n        await newId.save()\n        dispatch(saveUserId(identifier))\n      }\n      else {\n        const newId = await IdentifierAPI.findOne({\n          identifier: identifier\n        })\n        newId.update({\n          profile: newProfile\n        })\n        await newId.save()\n      }\n  \n      dispatch(saveProfileData(newProfile))\n      setSubmitState('fulfilled')\n    } catch (err) {\n      setSubmitState('rejected')\n    }\n    setTimeout(() => {\n      setSubmitState('')\n    }, 1000)\n  }\n\n  useEffect(() => {\n\t\tconst checkAuthData = async () => {\n      if(blockstackAPI.session.isUserSignedIn()) {\n        if(!authData) {\n          const getAuthData = await blockstackAPI.session.loadUserData()\n          dispatch(saveAuthData(getAuthData))\n        }\n\n        const id = await IdentifierAPI.findOne({\n          identifier: identifier\n        })\n    \n        if(id) {\n          setShowOnboarding(false)\n          dispatch(saveProfileData(id.attrs.profile))\n          dispatch(saveUserId(id.attrs.identifier))\n        }\n        setTimeout(() => {\n          setLoadingState(false)\n        }, 500)\n      }\n      else {\n        router.replace('/login')\n      }\n\t\t}\n    checkAuthData()\n    \n    const fetchThemeList = async () => {\n      const response = await themeAPI.fetch()\n      setThemeList(response.data.data)\n    }\n    fetchThemeList()\n  }, [])\n\n  useEffect(() => {\n    if(profile.name) {\n      setName(profile.name)\n    }\n    if(profile.description) {\n      setDescription(profile.description)\n    }\n    if(Array.isArray(profile.accountList)) {\n      const cloneAccountList = JSON.parse(JSON.stringify(profile.accountList))\n      setAccountList(cloneAccountList)\n    }\n    if(profile.avatarUrl) {\n      setAvatarUrl(profile.avatarUrl)\n    }\n    if(profile.theme) {\n      const cloneTheme = JSON.parse(JSON.stringify(profile.theme))\n      setTheme(cloneTheme)\n    }\n  }, [profile])\n\n  useEffect(() => {\n    const currentData = JSON.parse(JSON.stringify({\n      name: name,\n      description: description,\n      avatarUrl: avatarUrl,\n      accountList: accountList\n    }))\n    if(currentData.description) {\n      currentData.description = anchorme(currentData.description, {\n        attributes: [\n          {\n            name:\"target\",\n            value:\"_blank\"\n          }\n        ]\n      })\n    }\n  \n    if(theme) {\n      const path = 'index'\n      const page = theme.templatePage.find(page => page.path === path)\n      const compiled = handlebars.compile(page.template || '')(currentData)\n      setTemplate(compiled)\n    }\n  }, [theme, name, description, avatarUrl, accountList])\n\n  const toggleProfileSidebar = () => {\n    setShowProfileSidebar(!showProfileSidebar)\n  }\n\n  return (\n    <Layout>\n      <Head>\n        <title>Dashboard | Paras</title>\n        <link rel='icon' href='/favicon.ico' />\n      </Head>\n\n      <Meta />\n      <LoggedIn />\n      {\n        loadingState && (\n          <Loading />\n        )\n      }\n\n      <Nav toggleProfileSidebar={toggleProfileSidebar} />\n\n      {\n        showOnboarding && (\n          <Onboarding\n            identifier={identifier}\n            setIdentifer={setIdentifier}\n            name={name}\n            setName={setName} \n            description={description}\n            setDescription={setDescription} \n            accountList={accountList}\n            setAccountList={setAccountList}\n            avatarUrl={avatarUrl}\n            setAvatarUrl={setAvatarUrl}\n            avatarFile={avatarFile}\n            setAvatarFile={setAvatarFile}  \n            theme={theme}\n            setTheme={setTheme}\n            themeList={themeList}\n            submit={submit}\n            submitState={submitState}\n            showOnboarding={showOnboarding}\n            setShowOnboarding={setShowOnboarding}\n          />\n        )\n      }\n\n      <Sidebar \n        name={name}\n        setName={setName} \n        description={description}\n        setDescription={setDescription} \n        accountList={accountList}\n        setAccountList={setAccountList}\n        avatarUrl={avatarUrl}\n        setAvatarUrl={setAvatarUrl}\n        avatarFile={avatarFile}\n        setAvatarFile={setAvatarFile}  \n        theme={theme}\n        setTheme={setTheme}\n        themeList={themeList}\n        submit={submit}\n        submitState={submitState}\n        showProfileSidebar={showProfileSidebar}\n        toggleProfileSidebar={toggleProfileSidebar}\n        logout={logout}\n      />\n\n      <Frame className=\"w-screen\" style={{\n        height: `calc(100vh - 2.5rem)`\n      }}>\n        <div dangerouslySetInnerHTML={{\n          __html: template\n        }}></div>\n      </Frame>\n    </Layout>\n  )\n}\n\nexport default withRedux(Dashboard)"]},"metadata":{},"sourceType":"module"}